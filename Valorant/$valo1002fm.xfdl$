<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <!--<Form id="valo1002fm" width="1920" titletext="전적 검색 - 상세" border="none" background="url('theme://images/Valo_Match_search_background.png') no-repeat left top /100% 100% #101823" height="980" scrollbartype="none auto" onclick="valo1001fm_onclick">-->
  <Form id="valo1002fm" width="1920" titletext="전적 검색 - 상세" border="none" height="980" scrollbartype="none auto" onload="valo1002fm_onload">
    <Layouts>
      <Layout height="980" width="1920">
        <Div id="div_user_status" taborder="2" left="0" top="0" height="150" background="#31313c" right="0" formscrollbartype="none none">
          <Layouts>
            <Layout>
              <Static id="Logo_CHAMBER" taborder="3" left="728" top="-110" height="901" background="url('https://media.valorant-api.com/agents/22697a3d-45bf-8dd7-4fec-84a9e28c69d7/fullportrait.png') no-repeat center center /cover" opacity="50%" right="727" text=""/>
              <Static id="sta_user_status" taborder="0" top="15" width="540" height="120" color="white" font="normal 22pt/normal &quot;AppleSDGothicNeoB00&quot;" textAlign="left" padding="0px 0px 0px 130px" right="120" text="asdfafdsafsdf11" fittocontents="width"/>
              <Static id="sta_user_name" taborder="1" left="120" top="15" width="460" height="120" font="normal 30pt/normal &quot;AppleSDGothicNeoH00&quot;" color="white" text="asdfafdsafsdf" fittocontents="width"/>
              <Static id="sta_user_tag" taborder="2" left="sta_user_name:10" top="15" width="260" height="120" background="none" font="normal 22pt/normal &quot;AppleSDGothicNeoB00&quot;" color="#bbbbc7" text="asdfafdsafsdf" fittocontents="width"/>
            </Layout>
          </Layouts>
        </Div>
        <Grid id="Grid00" taborder="0" left="1000" top="190" width="880" height="710" autofittype="col" binddataset="ds_list">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row band="head" size="24"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="MAP"/>
                <Cell col="1" text="AGENT"/>
                <Cell col="2" text="ROLE"/>
                <Cell col="3" text="RESULT"/>
                <Cell col="4" text="RANK"/>
                <Cell col="5" text="KILL"/>
                <Cell col="6" text="DEATH"/>
                <Cell col="7" text="ASSIST"/>
                <Cell col="8" text="HS_RATE"/>
                <Cell col="9" text="ADR"/>
              </Band>
              <Band id="body">
                <Cell text="bind:MAP"/>
                <Cell col="1" text="bind:AGENT"/>
                <Cell col="2" text="bind:ROLE"/>
                <Cell col="3" text="bind:RESULT"/>
                <Cell col="4" text="bind:RANK"/>
                <Cell col="5" text="bind:KILL"/>
                <Cell col="6" text="bind:DEATH"/>
                <Cell col="7" text="bind:ASSIST"/>
                <Cell col="8" text="bind:HS_RATE"/>
                <Cell col="9" text="bind:ADR"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Static id="sta_hide_screen" taborder="1" left="0" top="930" background="black" visible="true" width="50" height="50"/>
        <Grid id="Grid01" taborder="3" left="0" top="180" width="980" height="740" binddataset="ds_stats" autofittype="col">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row band="head" size="24"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="TOTAL_KILL"/>
                <Cell col="1" text="TOTAL_DEATH"/>
                <Cell col="2" text="TOTAL_ASSIST"/>
                <Cell col="3" text="TOTAL_HEAD"/>
                <Cell col="4" text="TOTAL_BODY"/>
                <Cell col="5" text="TOTAL_LEG"/>
                <Cell col="6" text="MAX_KILL"/>
                <Cell col="7" text="PLAY_TIME"/>
                <Cell col="8" text="AVG_DMG"/>
                <Cell col="9" text="KD_RATE"/>
                <Cell col="10" text="KDA_RATE"/>
                <Cell col="11" text="AVG_SCORE"/>
              </Band>
              <Band id="body">
                <Cell text="bind:TOTAL_KILL"/>
                <Cell col="1" text="bind:TOTAL_DEATH"/>
                <Cell col="2" text="bind:TOTAL_ASSIST"/>
                <Cell col="3" text="bind:TOTAL_HEAD"/>
                <Cell col="4" text="bind:TOTAL_BODY"/>
                <Cell col="5" text="bind:TOTAL_LEG"/>
                <Cell col="6" text="bind:MAX_KILL"/>
                <Cell col="7" text="bind:PLAY_TIME"/>
                <Cell col="8" text="bind:AVG_DMG"/>
                <Cell col="9" text="bind:KD_RATE"/>
                <Cell col="10" text="bind:KDA_RATE"/>
                <Cell col="11" text="bind:AVG_SCORE"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
      </Layout>
    </Layouts>
    <Script type="xscript5.1"><![CDATA[this.fvApp = nexacro.getApplication();

this.valo1002fm_onload = function(obj:nexacro.Form,e:nexacro.LoadEventInfo)
{
    var username = this.fvApp.getVariable("gv_Recent_Search_Name");
    var usertag  = this.fvApp.getVariable("gv_Recent_Search_Tag");
    
    // alert(username + usertag); // 테스트용 얼럿은 주석 처리 추천
    
    this.div_user_status.form.sta_user_name.text = username;
    this.div_user_status.form.sta_user_tag.text = "#" + usertag;
    
    // 1. Transaction 설정
    var strSvcID        = "searchValorant";
    var strURL          = "SvcUrl::getValorantUserMatchData.do";
    var strInDatasets   = "";
    
    // ★★★ [수정 포인트] 서버에서 오는 ds_list와 ds_stats를 받도록 수정 ★★★
    // ClientDS=ServerDS 형식입니다.
    // 기존: "ds_tier=out_tier ds_matches=out_matches"
    // 변경: "ds_tier=out_tier ds_list=ds_list ds_stats=ds_stats"
    var strOutDatasets  = "ds_tier=out_tier ds_list=ds_list ds_stats=ds_stats";
    
    var strArgument     = "vName=" + nexacro.wrapQuote(username) + " vTag=" + nexacro.wrapQuote(usertag);
    var strCallbackFunc = "fn_Callback";
    
    this.transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
};

this.fn_Callback = function(svcId, errCode, errMsg)
{
	if(errCode < 0) {
        this.alert("조회 실패: " + errMsg);
        return;
    }

    if (svcId == "searchValorant") {
        
        // 2. 티어 정보 처리 (기존 로직 유지)
        if (this.ds_tier.rowcount > 0) {
			var tier     = this.ds_tier.getColumn(0, "TIER_NAME");
            var rr       = this.ds_tier.getColumn(0, "RR");
            var tierIcon = this.ds_tier.getColumn(0, "TIER_ICON");
            var wins     = this.ds_tier.getColumn(0, "SEASON_WINS");
            var total    = this.ds_tier.getColumn(0, "SEASON_GAMES");
            var winRate  = this.ds_tier.getColumn(0, "SEASON_WIN_RATE");
			
            var Statustext = "현재 티어: " + tier + " (" + rr + " 포인트)\n";
            Statustext += "이번 시즌: " + wins + "승 / " + total + "전 (" + winRate + "%)";
            
			//alert(Statustext);
			
            this.div_user_status.form.sta_user_status.text = Statustext;
			this.div_user_status.form.sta_user_status.background = "url("+tierIcon+") no-repeat left center /contain"
			
        } else {
            this.div_user_status.form.sta_user_status.text = "티어 정보 없음";
            this.div_user_status.form.sta_user_status.set_background("");
        }

        // 3. 통계 정보 바인딩 (★★★ 신규 추가 ★★★)
        if (this.ds_stats.rowcount > 0) {
            var avgDmg   = this.ds_stats.getColumn(0, "AVG_DMG");
            var kdRate   = this.ds_stats.getColumn(0, "KD_RATE");
            var headShot = this.ds_stats.getColumn(0, "TOTAL_HEAD");
            var playTime = this.ds_stats.getColumn(0, "PLAY_TIME");
            
            // 예: 통계 표시용 Static 컴포넌트들에 값 세팅
            // (화면에 만들어두신 컴포넌트 ID에 맞춰 수정하세요)
            // this.div_stats.form.sta_avg_dmg.text = "평균딜량: " + avgDmg;
            // this.div_stats.form.sta_kd.text      = "K/D: " + kdRate;
            
            // 확인용 로그
            trace(">>> 통계 로드 완료: K/D=" + kdRate + ", ADR=" + avgDmg);
        }

        // 4. 매치 리스트 처리
        // (기존 ds_matches를 ds_list로 이름을 변경했습니다.)
        if (this.ds_list.rowcount == 0) {
            this.alert("최근 경쟁전 전적이 없습니다.");
        } else {
            // this.alert("조회 완료! " + this.ds_list.rowcount + "건의 전적을 가져왔습니다.");
        }
        
        // 5. 화면 마무리
        this.div_user_status.form.resetScroll(); 
        this.sta_hide_screen.set_visible(false);
    }
};]]></Script>
    <Objects>
      <Dataset id="ds_tier">
        <ColumnInfo>
          <Column id="TIER_NAME" type="STRING" size="256"/>
          <Column id="RR" type="INT" size="256"/>
          <Column id="TIER_ICON" type="STRING" size="256"/>
          <Column id="SEASON_WINS" type="STRING" size="256"/>
          <Column id="SEASON_GAMES" type="STRING" size="256"/>
          <Column id="SEASON_WIN_RATE" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_matches">
        <ColumnInfo>
          <Column id="MAP" type="STRING" size="256"/>
          <Column id="AGENT" type="STRING" size="256"/>
          <Column id="ROLE" type="STRING" size="256"/>
          <Column id="RESULT" type="STRING" size="256"/>
          <Column id="RANK" type="INT" size="256"/>
          <Column id="KILL" type="INT" size="256"/>
          <Column id="DEATH" type="INT" size="256"/>
          <Column id="ASSIST" type="INT" size="256"/>
          <Column id="HS_RATE" type="FLOAT" size="256"/>
          <Column id="ADR" type="FLOAT" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_list">
        <ColumnInfo>
          <Column id="MAP" type="STRING" size="256"/>
          <Column id="AGENT" type="STRING" size="256"/>
          <Column id="ROLE" type="STRING" size="256"/>
          <Column id="RESULT" type="STRING" size="256"/>
          <Column id="RANK" type="INT" size="256"/>
          <Column id="KILL" type="INT" size="256"/>
          <Column id="DEATH" type="INT" size="256"/>
          <Column id="ASSIST" type="INT" size="256"/>
          <Column id="HS_RATE" type="FLOAT" size="256"/>
          <Column id="ADR" type="FLOAT" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_stats">
        <ColumnInfo>
          <Column id="TOTAL_KILL" type="INT" size="256"/>
          <Column id="TOTAL_DEATH" type="INT" size="256"/>
          <Column id="TOTAL_ASSIST" type="INT" size="256"/>
          <Column id="TOTAL_HEAD" type="INT" size="256"/>
          <Column id="TOTAL_BODY" type="INT" size="256"/>
          <Column id="TOTAL_LEG" type="INT" size="256"/>
          <Column id="MAX_KILL" type="INT" size="256"/>
          <Column id="PLAY_TIME" type="STRING" size="256"/>
          <Column id="AVG_DMG" type="FLOAT" size="256"/>
          <Column id="KD_RATE" type="FLOAT" size="256"/>
          <Column id="KDA_RATE" type="FLOAT" size="256"/>
          <Column id="AVG_SCORE" type="INT" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
  </Form>
</FDL>
