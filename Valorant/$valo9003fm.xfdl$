<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="valo9003fm" width="2000" height="980" titletext="반응속도 테스트" onload="valo9003fm_onload" onclose="valo9003fm_onclose" top="0" ontimer="valo9003fm_ontimer">
    <Layouts>
      <Layout height="980" width="2000">
        <Static id="sta_game_description" taborder="0" text="반응속도 테스트&#13;&#10;무작위 시간별로 화면 색이 바뀔때 클릭하세요 !&#13;&#10;총 3번을 진행하며 평균 시간을 체크합니다." left="80" top="47" width="774" height="114" color="white" font="normal 25pt/normal &quot;이사만루체 Medium&quot;"/>
        <Static id="sta_high_score" taborder="1" text="최고 기록 :" top="70" right="80" width="500" height="50" color="#00ff99" font="normal 30pt/normal &quot;이사만루체 Medium&quot;" textAlign="right" visible="false"/>
        <Button id="sta_result" taborder="2" text="" top="70" height="50" font="normal 30pt/normal &quot;이사만루체 Medium&quot;" color="white" visible="true" width="380" left="825"/>
        <Div id="div_game_zone" taborder="3" left="300" top="sta_game_description:50" background="rgba(128,128,128,0.5)" right="300" bottom="50" borderRadius="20px" border="3px solid gray" text="sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]sdafsdjfasdjkafdjklafd]">
          <Layouts>
            <Layout>
              <Button id="btn_game_start" taborder="0" text="게임 시작" left="600" top="300" height="100" font="normal 25pt/normal &quot;이사만루체 Medium&quot;" color="white" onclick="btn_game_start_onclick" fittocontents="none" background="rgba(255,0,0,0.5)" visible="false" width="200" border="3px solid red" borderRadius="20px" onmouseenter="Button_onmouseenter" onmouseleave="Button_onmouseleave"/>
            </Layout>
          </Layouts>
        </Div>
      </Layout>
    </Layouts>
    <Script type="xscript5.1"><![CDATA[this.fvApp = nexacro.getApplication();

// 설정 변수
this.nTotalRounds  = 3;      // 총 진행할 라운드 수
this.nCurrentRound = 0;      // 현재 라운드 (1 ~ 3)
this.arrScores     = [];     // 라운드별 점수(ms) 저장 배열

// 상태 관리 변수
this.sGameState    = "IDLE"; // IDLE(대기), WAIT(빨강-기다림), NOW(초록-클릭), FAIL(너무빠름), RESULT(라운드끝)
this.nGreenTime    = 0;      // 초록색으로 변한 시각

// 로그인 성공 시 호출할 함수
this.fn_setLoginState = function()
{
    // 로그인 여부 재확인
    if(this.fvApp.gds_login.getRowCount() == 0) return;
    var sLoginDiscordId = this.fvApp.gds_login.getColumn(0, "DISCORD_ID");
	var sLoginRiotId    = this.fvApp.gds_login.getColumn(0, "RIOT_ID");
	var sLoginRiotTag   = this.fvApp.gds_login.getColumn(0, "RIOT_TAG");
	
	
	this.sta_high_score.visible = true;
    // 로그인 하자마자 최고기록 조회
    this.fn_searchHighScore();
};

// 로그아웃 시 호출할 함수
this.fn_setLogoutState = function()
{
	this.sta_high_score.visible = false;
    this.sta_high_score.text = "";
};	

// 글로벌 데이터셋(gds_login) 변경 시
this.fn_LoginDataChanged = function(obj:nexacro.NormalDataset, e:nexacro.DSRowsetChangeEventInfo)
{
    // 1. 로그인이 된 경우 (데이터가 생김)
    if (obj.getRowCount() > 0) {
        // 아까 만든 로그인 상태 갱신 함수 호출
        this.fn_setLoginState(); 
    }
    // 2. 로그아웃 된 경우 (데이터가 사라짐)
    else {
        // 아까 만든 로그아웃 처리 함수 호출
        this.fn_setLogoutState();
    }
};

this.valo9003fm_onload = function(obj:nexacro.Form,e:nexacro.LoadEventInfo)
{
	// 이벤트 핸들러 추가
	this.fvApp.gds_login.addEventHandler("onrowsetchanged", this.fn_LoginDataChanged, this);
	this.fvApp.gds_login.addEventHandler("onload", this.fn_LoginDataChanged, this);
	
	// 들어오자마자 현재 로그인 상태인지 확인하여 즉시 반영
    if (this.fvApp.gds_login.getRowCount() > 0) {
        this.fn_setLoginState();
    } else {
        this.fn_setLogoutState();
    }
	this.fn_initStartBtn();
	
    
    var nFormWidth = this.getOffsetWidth();
    var nStaWidth  = this.sta_result.getOffsetWidth();
    
    // 왼쪽 좌표 계산: (화면너비 - 내너비) / 2
    var nLeft = (nFormWidth - nStaWidth) / 2;
    
    // 위치 이동 (Top은 현재 위치 유지, Left만 변경)
    this.sta_result.set_left(nLeft);
	
	// Div 자체에 클릭 이벤트 동적 연결
    this.div_game_zone.addEventHandler("onclick", this.div_game_zone_onclick, this);
	
    // 텍스트용 Static 동적 생성 (Div 내부에 꽉 차게)
    var objSta = new Static("sta_msg", 0, 0, null, null, 0, 0);
    
    objSta.textAlign = "center";
    objSta.verticalAlign = "middle";
    objSta.font = "normal 24pt/normal '이사만루체 Medium'";
    objSta.color = "#333333";
    objSta.text = "";
    
    // Static을 클릭해도 게임이 진행되도록 이벤트 연결
    objSta.addEventHandler("onclick", this.div_game_zone_onclick, this);
    
    this.div_game_zone.addChild("sta_msg", objSta);
    objSta.show();
	
	this.div_game_zone.text = "";
	this.div_game_zone.form.btn_game_start.bringToFront();
	
	this.resetScroll();
};


// 화면 닫힐 때
this.valo9003fm_onclose = function(obj:nexacro.Form,e:nexacro.CloseEventInfo)
{
	this.killTimer(99); // 반응속도 타이머 해제
	
	// 이벤트 핸들러 제거
    this.fvApp.gds_login.removeEventHandler("onrowsetchanged", this.fn_LoginDataChanged, this);
    this.fvApp.gds_login.removeEventHandler("onload", this.fn_LoginDataChanged, this);
};

// 게임 시작 버튼 클릭
this.btn_game_start_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
    // 변수 초기화
    this.nCurrentRound = 0;
    this.arrScores = [];
    
    this.div_game_zone.form.btn_game_start.visible = false; // 버튼 숨김
	
    this.div_game_zone.form.sta_msg.text = "화면을 클릭하면 시작합니다.";
    this.div_game_zone.form.sta_msg.color = "#333333";
	
    // 첫 라운드 시작
    this.fn_startRound();
};

// 라운드 시작 (대기 상태 - 빨강)
this.fn_startRound = function()
{
    this.nCurrentRound++;
    this.sta_result.text = "Round " + this.nCurrentRound + " / " + this.nTotalRounds;
    this.resetScroll();
    // 상태 변경: 대기
    this.sGameState = "WAIT";
    
    // 화면 스타일 변경 (빨강)
    this.div_game_zone.background = "#ce2636";
    this.div_game_zone.form.sta_msg.text = "초록색이 되면 클릭하세요.\n(기다리세요...)";
    this.div_game_zone.form.sta_msg.color = "white";
    this.div_game_zone.form.sta_msg.font = "normal 24pt/normal '이사만루체 Medium'";
    
    // 랜덤 시간 계산 (3000ms ~ 8000ms)
    var nRandomTime = Math.floor(Math.random() * 5000) + 3000;
    
    // 타이머 시작 (ID: 99)
    this.setTimer(99, nRandomTime);
};

// 타이머 작동 (초록색으로 변경)
this.valo9003fm_ontimer = function(obj:nexacro.Form,e:nexacro.TimerEventInfo)
{
    if (e.timerid == 99)
    {
        this.killTimer(99); // 타이머 종료
        
        // 상태 변경: 클릭 가능
        this.sGameState = "NOW";
        this.nGreenTime = new Date().getTime(); // 현재 시간 기록
        
        // 화면 스타일 변경 (초록)
        this.div_game_zone.background = "#4bdb6a";
        this.div_game_zone.form.sta_msg.text = "클릭!!!!!";
        this.div_game_zone.form.sta_msg.color = "white";
        this.div_game_zone.form.sta_msg.font = "normal 40pt/normal '이사만루체 Medium'";
    }
};

// 화면 클릭
this.div_game_zone_onclick = function(obj:nexacro.Div, e:nexacro.ClickEventInfo)
{
	// 버튼 누르면 정지
	if (e.fromreferenceobject.id == "btn_game_start") return;

    // 게임 중이 아니면 무시 (시작 버튼이 켜져있을 때)
    if (this.div_game_zone.form.btn_game_start.visible) return;
	
    var nNow = new Date().getTime();
	
    // 대기 중 클릭 (너무 빨리 클릭함 - 빨강일 때)
    if (this.sGameState == "WAIT") {
        this.killTimer(99); // 타이머 취소
        this.sGameState = "FAIL";
        
        this.div_game_zone.background = "#2b87d1"; // 파랑/회색 계열
        this.div_game_zone.form.sta_msg.text = "너무 빨라요!\n(클릭해서 다시 시도)";
        this.div_game_zone.form.sta_msg.font = "normal 24pt/normal '이사만루체 Medium'";
        
        // 라운드 횟수 되돌리기 (실패했으므로)
        this.nCurrentRound--; 
    }
    // 신호 후 클릭 (성공 - 초록일 때)
    else if (this.sGameState == "NOW") {
        this.sGameState = "RESULT";
        
        // 반응속도 계산
        var nScore = nNow - this.nGreenTime;
        this.arrScores.push(nScore); // 점수 저장
        
        this.div_game_zone.background = "#ffffff"; // 흰색
        this.div_game_zone.form.sta_msg.color = "black";
        this.div_game_zone.form.sta_msg.font = "normal 30pt/normal '이사만루체 Medium'";
        
        // 마지막 라운드인지 확인
        if (this.nCurrentRound >= this.nTotalRounds) {
            this.div_game_zone.form.sta_msg.text = nScore + " ms\n(모든 라운드 종료! 결과 확인 클릭)";
        } else {
            this.div_game_zone.form.sta_msg.text = nScore + " ms\n(클릭해서 다음 라운드 진행)";
        }
    }
    // C. 결과 화면/실패 화면에서 클릭 (다음 진행)
    else if (this.sGameState == "RESULT" || this.sGameState == "FAIL") {
        // 마지막 라운드였다면 게임 종료
        if (this.sGameState == "RESULT" && this.nCurrentRound >= this.nTotalRounds) {
            this.fn_finishGame();
        } 
        // 아니면 다음 라운드(혹은 재시도) 시작
        else {
            this.div_game_zone.form.sta_msg.font = "normal 24pt/normal '이사만루체 Medium'";
            this.fn_startRound();
        }
    }
};

// 게임 종료 및 평균 계산
this.fn_finishGame = function()
{
    this.sGameState = "IDLE";
	this.div_game_zone.form.sta_msg.text = ""; // 텍스트 지움
    this.div_game_zone.background = "rgba(128,128,128,0.5)"; // 배경 초기화
    
    // 평균 계산
    var nSum = 0;
    for(var i=0; i<this.arrScores.length; i++) {
        nSum += this.arrScores[i];
    }
    var nAvg = Math.floor(nSum / this.nTotalRounds); // 소수점 버림
    
    this.sta_result.text = "";
    var nTracker = (nAvg / 1000).toFixed(3);
    var sMsgId = "msg.notice.game_result2";	//메세지ID
	var arrArg = [nTracker];			//메세지취환될값 배열[생략가능]
	var sPopId = sMsgId;						//메세지팝업ID[생략가능] *해당화면에서 메시지 중복사용시 구분되는값을 넣어줘야함
	var sMsgCallback = "fnMsgCallback";			//메세지콜백[생략가능] * confirm성 메시지를 사용 시 반드시 필요
	
	// function 전달
	this.gfnAlert(sMsgId, arrArg, sPopId, function(strId, strVal) {
			if (strVal == true) {
				// 확인 선택
				this.div_game_zone.form.btn_game_start.click();
			}
			else {
				// 취소 선택
				this.fn_initStartBtn();
			}
		});
	
	
    // 시작 버튼 복구
    this.fn_initStartBtn();
    this.div_game_zone.form.btn_game_start.text = "다시 하기";
    
    // 로그인 상태라면 DB 저장 (기존 로직 활용)
    if (this.fvApp.gds_login.getRowCount() > 0) {
        this.fn_saveScore(nAvg);
    }
    this.resetScroll();
};

// === [기존 통신 로직 유지] ===
this.fn_searchHighScore = function() {
    var sDiscordId = this.fvApp.gds_login.getColumn(0, "DISCORD_ID");
    
    var strSvcID    = "getHighScore";
    var strURL      = "SvcUrl::getHighScore.do";
    var strInDatasets  = "";
    var strOutDatasets = "ds_highscore=out_highscore";
    var strArgument    = "discord_id=" + nexacro.wrapQuote(sDiscordId);
    var strCallbackFunc = "fn_Callback";
    
    this.transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
};

this.fn_saveScore = function(nScore) {
    var sDiscordId = this.fvApp.gds_login.getColumn(0, "DISCORD_ID");
    var sUserName  = this.fvApp.gds_login.getColumn(0, "USER_NAME");
    
    var strSvcID    = "saveGameScore";
    var strURL      = "SvcUrl::saveGameScore.do";
    var strInDatasets  = "";
    var strOutDatasets = "";
    
    var strArgument = "discordId=" + nexacro.wrapQuote(sDiscordId) + 
	" userName=" + nexacro.wrapQuote(sUserName) +
	" type='SPEED'" +  
	" score=" + nScore; 
	
    var strCallbackFunc = "fn_Callback";
    
    this.transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
};

this.fn_Callback = function(svcId, errCode, errMsg) {
    if (errCode < 0) {
        alert("통신 에러: " + errMsg);
        return;
    }
    if (svcId == "getHighScore") {
        var sTracker = "없음";
        if (this.ds_highscore.getRowCount() > 0) {
            var nTracker = this.ds_highscore.getColumn(0, "SPEED");
			nTracker = (nTracker / 1000).toFixed(3);
			
            if (nTracker != null && nTracker != undefined && String(nTracker) != "" && nTracker > 0) {
                sTracker = nTracker + "초";
            }
        }
        this.sta_high_score.text = "나의 최고기록 : " + sTracker;
    }
    else if (svcId == "saveGameScore") {
        this.fn_searchHighScore();
    }
};

// 버튼 위치 초기화
this.fn_initStartBtn = function() {
    var objDiv = this.div_game_zone;
    var objBtn = this.div_game_zone.form.btn_game_start;
    var nDivWidth  = objDiv.getOffsetWidth();
    var nDivHeight = objDiv.getOffsetHeight();
    var nBtnWidth  = objBtn.getOffsetWidth();
    var nBtnHeight = objBtn.getOffsetHeight();
    var nLeft = (nDivWidth - nBtnWidth) / 2;
    var nTop  = (nDivHeight - nBtnHeight) / 2;
    objBtn.move(nLeft, nTop, nBtnWidth, nBtnHeight);
    objBtn.visible = true;
};
]]></Script>
    <Objects>
      <Dataset id="ds_highscore">
        <ColumnInfo>
          <Column id="USER_NAME" type="STRING" size="256"/>
          <Column id="SPEED" type="INT" size="256"/>
          <Column id="TRACKER" type="INT" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
  </Form>
</FDL>
