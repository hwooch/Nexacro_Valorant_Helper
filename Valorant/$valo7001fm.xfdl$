<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="valo7001fm" width="2000" height="980" titletext="파티 구인" onload="valo7001fm_onload" onclose="valo7001fm_onclose">
    <Layouts>
      <Layout height="980" width="2000">
        <Button id="btn_agent_filter_all" taborder="7" left="100" top="80" width="110" height="60" background="url('theme://images/valo_all.png') no-repeat left top /contain #31313c" text="전체" textAlign="right" padding="0px px 0px 0px" border="15px solid #31313c" borderRadius="20px" font="normal 15pt/normal &quot;이사만루체 Light&quot;" color="white" onmouseenter="btn_agent_filter_onmouseenter" onmouseleave="btn_agent_filter_onmouseleave" opacity="50%" onclick="btn_agent_filter_onclick"/>
        <Button id="btn_agent_filter_watch" taborder="0" left="btn_agent_filter_all:10" top="80" width="130" height="60" background="url('https://media.valorant-api.com/agents/roles/5fc02f99-4091-4486-a531-98459a3e95e9/displayicon.png') no-repeat left top /contain #31313c" text="감시자" textAlign="right" padding="0px px 0px 0px" border="15px solid #31313c" borderRadius="20px" font="normal 15pt/normal &quot;이사만루체 Light&quot;" color="white" onmouseenter="btn_agent_filter_onmouseenter" onmouseleave="btn_agent_filter_onmouseleave" opacity="50%" onclick="btn_agent_filter_onclick"/>
        <Button id="btn_agent_filter_enter" taborder="1" left="btn_agent_filter_watch:10" top="80" width="130" height="60" background="url('https://media.valorant-api.com/agents/roles/dbe8757e-9e92-4ed4-b39f-9dfc589691d4/displayicon.png') no-repeat left top /contain #31313c" text="타격대" textAlign="right" padding="0px px 0px 0px" border="15px solid #31313c" borderRadius="20px" font="normal 15pt/normal &quot;이사만루체 Light&quot;" color="white" onmouseenter="btn_agent_filter_onmouseenter" onmouseleave="btn_agent_filter_onmouseleave" opacity="50%" onclick="btn_agent_filter_onclick"/>
        <Button id="btn_agent_filter_info" taborder="2" left="btn_agent_filter_enter:10" top="80" width="130" height="60" background="url('https://media.valorant-api.com/agents/roles/1b47567f-8f7b-444b-aae3-b0c634622d10/displayicon.png') no-repeat left top /contain #31313c" text="척후대" textAlign="right" padding="0px px 0px 0px" border="15px solid #31313c" borderRadius="20px" font="normal 15pt/normal &quot;이사만루체 Light&quot;" color="white" onmouseenter="btn_agent_filter_onmouseenter" onmouseleave="btn_agent_filter_onmouseleave" opacity="50%" onclick="btn_agent_filter_onclick"/>
        <Button id="btn_agent_filter_smoke" taborder="3" left="btn_agent_filter_info:10" top="80" width="130" height="60" background="url('https://media.valorant-api.com/agents/roles/4ee40330-ecdd-4f2f-98a8-eb1243428373/displayicon.png') no-repeat left top /contain #31313c" text="전략가" textAlign="right" padding="0px px 0px 0px" border="15px solid #31313c" borderRadius="20px" font="normal 15pt/normal &quot;이사만루체 Light&quot;" color="white" onmouseenter="btn_agent_filter_onmouseenter" onmouseleave="btn_agent_filter_onmouseleave" opacity="50%" onclick="btn_agent_filter_onclick"/>
        <Combo id="combo_tier_filter" taborder="4" left="btn_agent_filter_smoke:20" top="80" width="190" height="60" innerdataset="ds_combo_tier" codecolumn="CODE" datacolumn="DATA" cssclass="valo_combo_tier" index="0" tabstop="false" cursor="pointer" text="티어 전체" value="1" onitemchanged="combo_tier_filter_onitemchanged"/>
        <Button id="btn_write" taborder="5" top="80" height="60" background="url('theme://images/valo_write.png') no-repeat left top /contain #4c4c5a" text="구인 글 작성하기" textAlign="right" padding="0px 3px 0px 0px" border="10px solid #4c4c5a" borderRadius="20px" font="normal 15pt/normal &quot;이사만루체 Light&quot;" color="white" width="206" right="80" onclick="btn_write_onclick" cursor="pointer" cssclass="btn_shadow"/>
        <Grid id="Grid00" taborder="6" left="108" top="1020" width="1709" height="502" binddataset="ds_tier" autofittype="col">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row size="24" band="head"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="TIER_NAME"/>
                <Cell col="1" text="RR"/>
                <Cell col="2" text="TIER_ICON"/>
                <Cell col="3" text="SEASON_WINS"/>
                <Cell col="4" text="SEASON_GAMES"/>
                <Cell col="5" text="SEASON_WIN_RATE"/>
              </Band>
              <Band id="body">
                <Cell text="bind:TIER_NAME" edittype="text"/>
                <Cell col="1" text="bind:RR" edittype="text"/>
                <Cell col="2" text="bind:TIER_ICON" edittype="text"/>
                <Cell col="3" text="bind:SEASON_WINS" edittype="text"/>
                <Cell col="4" text="bind:SEASON_GAMES" edittype="text"/>
                <Cell col="5" text="bind:SEASON_WIN_RATE" edittype="text"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Grid id="Grid01" taborder="8" left="150" top="432" width="1662" height="527" binddataset="gds_party" autofittype="col">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row band="head" size="24"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="BOARD_NO"/>
                <Cell col="1" text="DISCORD_ID"/>
                <Cell col="2" text="USER_NAME"/>
                <Cell col="3" text="USER_TAG"/>
                <Cell col="4" text="USER_MEMO"/>
                <Cell col="5" text="USER_CLASS"/>
                <Cell col="6" text="USER_MIC"/>
                <Cell col="7" text="TIER"/>
                <Cell col="8" text="TIER_ICON"/>
                <Cell col="9" text="WINS"/>
                <Cell col="10" text="GAMES"/>
                <Cell col="11" text="WIN_RATES"/>
                <Cell col="12" text="WRITE_TIME"/>
              </Band>
              <Band id="body">
                <Cell text="bind:BOARD_NO"/>
                <Cell col="1" text="bind:DISCORD_ID"/>
                <Cell col="2" text="bind:USER_NAME"/>
                <Cell col="3" text="bind:USER_TAG"/>
                <Cell col="4" text="bind:USER_MEMO"/>
                <Cell col="5" text="bind:USER_CLASS"/>
                <Cell col="6" text="bind:USER_MIC"/>
                <Cell col="7" text="bind:TIER"/>
                <Cell col="8" text="bind:TIER_ICON"/>
                <Cell col="9" text="bind:WINS"/>
                <Cell col="10" text="bind:GAMES"/>
                <Cell col="11" text="bind:WIN_RATES"/>
                <Cell col="12" text="bind:WRITE_TIME"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
      </Layout>
    </Layouts>
    <Script type="xscript5.1"><![CDATA[this.fvApp = nexacro.getApplication();

// 현재 선택된 필터 버튼을 저장할 변수
this.fv_selectedFilterBtn = null;

// 조회 트랜잭션에 쓰일 변수
var sClass = "전체";
var sTier  = "전체";

this.btn_agent_filter_onmouseenter = function(obj:nexacro.Button,e:nexacro.MouseEventInfo)
{
	// 마우스 올리면 무조건 밝게
    this.fn_setFilterStyle(obj, "hover");
};

this.btn_agent_filter_onmouseleave = function(obj:nexacro.Button,e:nexacro.MouseEventInfo)
{
	//  현재 선택된 버튼이라면, 마우스가 나가도 'normal'(어둠)로 바꾸지 않음!
    if (this.fv_selectedFilterBtn == obj) {
        this.fn_setFilterStyle(obj, "selected"); // 그림자만 빼고 밝은 상태 유지
    } else {
        this.fn_setFilterStyle(obj, "normal");   // 선택 안된 놈은 다시 어둡게
    }
};

this.btn_agent_filter_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	// 이미 선택된 버튼을 또 누르면 아무것도 안 함
    if (this.fv_selectedFilterBtn == obj) {
		//return;
	}
    //이전에 선택되어 있던 버튼이 있다면 -> 원래대로 어둡게 되돌리기
    if (this.fv_selectedFilterBtn) {
        this.fn_setFilterStyle(this.fv_selectedFilterBtn, "normal");
    }
	
    // 현재 누른 버튼 -> 선택된 상태로 저장 및 스타일 적용
    this.fv_selectedFilterBtn = obj;
    this.fn_setFilterStyle(obj, "selected");
    
    
	// 필터링 버튼 클릭 메소드	
    var sFilterRole = "전체"; // 기본값
	
    switch(obj.id) {
	case "btn_agent_filter_watch":
		sFilterRole = "감시자";
		break;
	case "btn_agent_filter_smoke":
		sFilterRole = "전략가";
		break;
	case "btn_agent_filter_enter":
		sFilterRole = "타격대";
		break;
	case "btn_agent_filter_info":
		sFilterRole = "척후대";
		break;
	default:
		sFilterRole = "전체";
    }
	sClass = sFilterRole;
	this.fn_search_party_list(sFilterRole, sTier);
};

// 버튼 스타일 통합 관리 함수
// status: "normal" (평소/어둠), "selected" (클릭/밝음), "hover" (마우스올림/밝음)
this.fn_setFilterStyle = function(obj, status)
{
    var btn_agent_watch = "https://media.valorant-api.com/agents/roles/5fc02f99-4091-4486-a531-98459a3e95e9/displayicon.png";
    var btn_agent_enter = "https://media.valorant-api.com/agents/roles/dbe8757e-9e92-4ed4-b39f-9dfc589691d4/displayicon.png";
    var btn_agent_smoke = "https://media.valorant-api.com/agents/roles/4ee40330-ecdd-4f2f-98a8-eb1243428373/displayicon.png";
    var btn_agent_info  = "https://media.valorant-api.com/agents/roles/1b47567f-8f7b-444b-aae3-b0c634622d10/displayicon.png";
	
    var sColor = "";
    
    // 선택되었거나 마우스가 올라갔을 때 (밝은 상태)
    if (status == "selected" || status == "hover") {
        obj.opacity = "";
        obj.border = "15px solid #4c4c5a";
        sColor = "#4c4c5a";
        
        if (status == "hover") {
			obj.cursor = "pointer";
			obj.boxShadow = "0px 0px 5px #ffffff";
        } else {
			obj.cursor = "default";
			obj.boxShadow = "";
        }
    } 
    // 평소 상태 (어두운 상태)
    else {
        obj.opacity = "50%";
        obj.border = "15px solid #31313c";
        sColor = "#31313c";
        obj.cursor = "pointer";
        obj.boxShadow = "";
    }
	
    // 배경 이미지 설정
    switch(obj.id) {
	case "btn_agent_filter_all":
		obj.background = "url('theme://images/valo_all.png') no-repeat left top /contain " + sColor;
		break;
	case "btn_agent_filter_watch":
		obj.background = "url('"+ btn_agent_watch +"') no-repeat left top /contain " + sColor;
		break;
	case "btn_agent_filter_smoke":
		obj.background = "url('"+ btn_agent_smoke +"') no-repeat left top /contain " + sColor;
		break;
	case "btn_agent_filter_enter":
		obj.background = "url('"+ btn_agent_enter +"') no-repeat left top /contain " + sColor;
		break;
	case "btn_agent_filter_info":
		obj.background = "url('"+ btn_agent_info +"') no-repeat left top /contain " + sColor;
		break;
    }
};

this.btn_write_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	var objChildFrame = new ChildFrame("popupModal", 0, 0, 480, 420);
	objChildFrame.formurl = "Popup::valo2001pu.xfdl";
 	objChildFrame.openalign = "center middle";
 	objChildFrame.overlaycolor = "RGBA(0,0,0,0.4)";
	objChildFrame.dragmovetype = "all";
	objChildFrame.showtitlebar = true;
	objChildFrame.set_titlebarheight(40);
	objChildFrame.cssclass = "valo_popup";
	
	objChildFrame.showModal(this.getOwnerFrame(), "", this, "fn_popupCallback");
};

this.fn_popupCallback = function(strPopupID, strReturn)
{
	if(strReturn == undefined){
		return;
	}
	if(strPopupID == "popupModal"){
		var Party_name  = strReturn.split("||")[0];
		var Party_tag   = strReturn.split("||")[1];
		var Party_memo  = strReturn.split("||")[2];
		var Party_class = strReturn.split("||")[3];
		var Party_mic   = strReturn.split("||")[4];
		var Party_discord_id = this.fvApp.gds_login.getColumn(0, "DISCORD_ID");
		var Party_board_num = "new_write";
		
		// 글 저장 transaction
		var strSvcID        = "saveParty";
		var strURL          = "SvcUrl::saveParty.do";
		var strInDatasets   = "in_tier=ds_tier";
		var strOutDatasets  = "gds_party=out_party";
		var strArgument     = "vParty_name=" + nexacro.wrapQuote(Party_name) + " vParty_tag=" + nexacro.wrapQuote(Party_tag)
		+ " vParty_class=" + nexacro.wrapQuote(Party_class) + " vParty_memo=" + nexacro.wrapQuote(Party_memo)
		+ " vParty_mic=" + nexacro.wrapQuote(Party_mic) + " vParty_discord_id=" + nexacro.wrapQuote(Party_discord_id)
		+ " vParty_board_num=" + nexacro.wrapQuote(Party_board_num);
		var strCallbackFunc = "fn_Callback";
		
		this.transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
	}
};

this.valo7001fm_onload = function(obj:nexacro.Form,e:nexacro.LoadEventInfo)
{
	// 이벤트 핸들러 추가
	this.fvApp.gds_login.addEventHandler("onrowsetchanged", this.fn_LoginDataChanged, this);
	this.fvApp.gds_login.addEventHandler("onload", this.fn_LoginDataChanged, this);
	
	// 들어오자마자 현재 로그인 상태인지 확인하여 즉시 반영
    if (this.fvApp.gds_login.getRowCount() > 0) {
		this.fn_transaction();
    } else {
		this.ds_tier.clearData();
    }
	
	this.btn_agent_filter_all.click();
};

// 화면 닫힐 때
this.valo7001fm_onclose = function(obj:nexacro.Form,e:nexacro.CloseEventInfo)
{
	// 이벤트 핸들러 제거
    this.fvApp.gds_login.removeEventHandler("onrowsetchanged", this.fn_LoginDataChanged, this);
    this.fvApp.gds_login.removeEventHandler("onload", this.fn_LoginDataChanged, this);
};

// 글로벌 데이터셋(gds_login) 변경 시
this.fn_LoginDataChanged = function(obj:nexacro.NormalDataset, e:nexacro.DSRowsetChangeEventInfo)
{
    // 1. 로그인이 된 경우 (데이터가 생김)
    if (obj.getRowCount() > 0) {
		this.fn_transaction();
    }
    // 2. 로그아웃 된 경우 (데이터가 사라짐)
    else {
		this.ds_tier.clearData();
    }
};

this.fn_transaction = function () {
	var objEnv = nexacro.getEnvironment();
	objEnv.usewaitcursor = false;
	
	var username = this.fvApp.gds_login.getColumn(0, "RIOT_ID");
	var usertag = this.fvApp.gds_login.getColumn(0, "RIOT_TAG");
	
	// 내 티어 조회 transaction
	var strSvcID        = "searchTier";
	var strURL          = "SvcUrl::getValorantTier.do";
	var strInDatasets   = "";
	var strOutDatasets  = "ds_tier=out_tier";
	var strArgument     = "vName=" + nexacro.wrapQuote(username) + " vTag=" + nexacro.wrapQuote(usertag);
	var strCallbackFunc = "fn_Callback";
	
	this.transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
}

this.fn_Callback = function(svcId, errCode, errMsg)
{
    if(errCode < 0) {
		return;
    }
	// 티어 조회
    if (svcId == "searchTier") {
		var objEnv = nexacro.getEnvironment();
		objEnv.usewaitcursor = true;
	}
	if (svcId == "searchParty") {
		//alert("조회 완료");
	} if (svcId == "saveParty") {
		//alert("저장 완료");
		this.btn_agent_filter_all.click();
	}
}
this.combo_tier_filter_onitemchanged = function(obj:nexacro.Combo,e:nexacro.ItemChangeEventInfo)
{
	sTier = this.combo_tier_filter.value;
	if(sTier == "티어 전체"){
		sTier = "전체";
	}
	this.fn_search_party_list(sClass, sTier);
};


this.fn_search_party_list = function (user_class ,user_tier)
{	
	// 글 조회 transaction
	var strSvcID        = "searchParty";
	var strURL          = "SvcUrl::searchParty.do";
	var strInDatasets   = "";
	var strOutDatasets  = "gds_party=out_party";
	var strArgument     = "vParty_class=" + nexacro.wrapQuote(user_class) + 
	" vParty_tier=" + nexacro.wrapQuote(user_tier);
	var strCallbackFunc = "fn_Callback";
	
	this.transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
};]]></Script>
    <Objects>
      <Dataset id="ds_combo_tier">
        <ColumnInfo>
          <Column id="DATA" type="STRING" size="256"/>
          <Column id="CODE" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="DATA">티어 전체</Col>
            <Col id="CODE">전체</Col>
          </Row>
          <Row>
            <Col id="DATA">아이언</Col>
            <Col id="CODE">Iron</Col>
          </Row>
          <Row>
            <Col id="DATA">브론즈</Col>
            <Col id="CODE">Bronze</Col>
          </Row>
          <Row>
            <Col id="DATA">실버</Col>
            <Col id="CODE">Silver</Col>
          </Row>
          <Row>
            <Col id="DATA">골드</Col>
            <Col id="CODE">Gold</Col>
          </Row>
          <Row>
            <Col id="DATA">플래티넘</Col>
            <Col id="CODE">Platinum</Col>
          </Row>
          <Row>
            <Col id="DATA">다이아</Col>
            <Col id="CODE">Diamond</Col>
          </Row>
          <Row>
            <Col id="DATA">초월자</Col>
            <Col id="CODE">Ascendant</Col>
          </Row>
          <Row>
            <Col id="DATA">불멸</Col>
            <Col id="CODE">Immortal</Col>
          </Row>
          <Row>
            <Col id="DATA">레디언트</Col>
            <Col id="CODE">Radiant</Col>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="ds_tier">
        <ColumnInfo>
          <Column id="TIER_NAME" type="STRING" size="256"/>
          <Column id="RR" type="INT" size="256"/>
          <Column id="TIER_ICON" type="STRING" size="256"/>
          <Column id="SEASON_WINS" type="STRING" size="256"/>
          <Column id="SEASON_GAMES" type="STRING" size="256"/>
          <Column id="SEASON_WIN_RATE" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
  </Form>
</FDL>
