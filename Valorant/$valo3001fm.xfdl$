<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="valo3001fm" width="2000" height="980" titletext="스킨" onload="valo3001fm_onload">
    <Layouts>
      <Layout height="980" width="2000">
        <Div id="div_weapon" left="2860" top="220" height="120" right="-2820" text="" background="white"/>
        <Div id="div_tier" left="2860" top="350" height="90" right="-2820" background="white" text=""/>
        <Div id="div_skin_list" left="2860" top="460" right="-2820" bottom="-180" background="white" autoscrollbar="true" text="">
          <Layouts>
            <Layout/>
          </Layouts>
        </Div>
        <Button id="Button00" taborder="3" text="스킨 최신데이터 리로드" left="2110" top="128" width="410" height="105" background="white" onclick="Button00_onclick"/>
        <Grid id="Grid00" taborder="4" left="63" top="20" height="220" binddataset="ds_weapon" autofittype="col" right="440">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row band="head" size="24"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="UUID"/>
                <Cell col="1" text="NAME"/>
                <Cell col="2" text="ICON"/>
              </Band>
              <Band id="body">
                <Cell text="bind:UUID"/>
                <Cell col="1" text="bind:NAME"/>
                <Cell col="2" text="bind:ICON"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Grid id="Grid01" taborder="5" left="63" top="286" height="234" binddataset="ds_tier" autofittype="col" right="20">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row band="head" size="24"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="UUID"/>
                <Cell col="1" text="NAME"/>
                <Cell col="2" text="ICON"/>
                <Cell col="3" text="COLOR"/>
              </Band>
              <Band id="body">
                <Cell text="bind:UUID"/>
                <Cell col="1" text="bind:NAME"/>
                <Cell col="2" text="bind:ICON"/>
                <Cell col="3" text="bind:COLOR"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Grid id="Grid02" taborder="6" left="66" top="590" height="496" binddataset="ds_skin" autofittype="col" right="20">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row band="head" size="24"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="WEAPON_UUID"/>
                <Cell col="1" text="TIER_UUID"/>
                <Cell col="2" text="NAME"/>
                <Cell col="3" text="ICON"/>
                <Cell col="4" text="TIER_ICON"/>
                <Cell col="5" text="TIER_COLOR"/>
              </Band>
              <Band id="body">
                <Cell text="bind:WEAPON_UUID"/>
                <Cell col="1" text="bind:TIER_UUID"/>
                <Cell col="2" text="bind:NAME"/>
                <Cell col="3" text="bind:ICON"/>
                <Cell col="4" text="bind:TIER_ICON"/>
                <Cell col="5" text="bind:TIER_COLOR"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Button id="Button01" taborder="7" text="팝업창열기" left="2315" top="410" width="170" height="163" background="yellow" onclick="Button01_onclick"/>
      </Layout>
    </Layouts>
    <Script type="xscript5.1"><![CDATA[this.fv_selectedWeapon = "all"; 
this.fv_selectedTier = "all";   

this.valo3001fm_onload = function(obj:nexacro.Form,e:nexacro.LoadEventInfo)
{
	this.fn_getData2();
};

// 데이터 불러오는 버튼
this.Button00_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	this.fn_getData(); 
};

// API 스킨 데이터 불러오는 transaction
this.fn_getData = function() {
    var strSvcID    		= "searchSkin";
    var strURL      		= "SvcUrl::getSkinDataFromApi.do";
    var strInDatasets    	= "";
    var strOutDatasets      = "ds_weapon=out_weapon ds_tier=out_tier ds_skin=out_skin";
    var strArgument         = "";
    var strCallbackFunc     = "fn_Callback";
	
    this.transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
};

// DB 스킨 데이터 불러오는 transaction
this.fn_getData2 = function() {
    var strSvcID    		= "searchDBskin";
    var strURL      		= "SvcUrl::getValorantSkinData.do";
    var strInDatasets    	= "";
    var strOutDatasets      = "ds_weapon=out_weapon ds_tier=out_tier ds_skin=out_skin";
    var strArgument         = "";
    var strCallbackFunc     = "fn_Callback";
	
    this.transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
};

this.fn_Callback = function(svcID, errCode, errMsg) {
    if (errCode < 0) {
        alert("데이터 로드 실패: " + errMsg);
        return;
    }
    
    if (svcID == "searchSkin") {
//         this.fn_makeFilterButtons(this.ds_weapon, this.div_weapon, "weapon");
//         this.fn_makeFilterButtons(this.ds_tier, this.div_tier, "tier");
//         this.fn_applyFilter();
    }
};

this.Button01_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	var sTitle = "팝업에 form 연결";
	var sFormUrl  = "Sample::SampleTransaction.xfdl";
	var oArg = {paramCode:"abcd", paramNum:12345, paramUrl:sFormUrl};
	var oOption = {title:sTitle,width:"800",height:"600"};	//top, left를 지정하지 않으면 가운데정렬 //"top:20,left:370"
	var sPopupCallBack = "fnPopupCallback";
	this.gfnOpenPopup( "popup","Cmm::CmmPopup.xfdl",oArg,sPopupCallBack,oOption);	
};


// 필터 버튼 생성
this.fn_makeFilterButtons = function(ds, divObj, type) {
	var nLeft = 10, nTop = 10, nWidth = 140, nHeight = 36, nGap = 8;
	var targetForm = divObj.form;
	
	for(var i = targetForm.components.length-1 ; i >= 0; i--) {
		objRemoved = targetForm.removeChild(targetForm.components[i].id);
		objRemoved.destroy();
		objRemoved = null;
	}
	
	for(var i = 0; i < ds.rowcount; i++) {
		if (nLeft + nWidth > divObj.getOffsetWidth() - 20) {
			nLeft = 10; nTop += nHeight + nGap;
		}
		
		var btnId = "btn_" + type + "_" + i;
		
		var objDiv = new Div(btnId, nLeft, nTop, nWidth, nHeight);
		targetForm.addChild(btnId, objDiv);
		objDiv.cssclass("skins_weapon");
		objDiv.tabstop(false); 
		objDiv.accessibilityenable(false);
		objDiv._uuid = ds.getColumn(i, "uuid");
		objDiv._type = type;
		objDiv.addEventHandler("onclick", this.fn_filter_onclick, this);
		objDiv.show();
		
		var objImg = new ImageViewer("img_icon", 8, 7, 30, 22);
		objDiv.form.addChild("img_icon", objImg);
		objImg.image(ds.getColumn(i, "icon"));
		objImg.stretch("fixaspectratio"); // 버튼 내 아이콘도 비율 유지
		objImg.addEventHandler("onclick", this.fn_filter_onclick, this);
		objImg.show();
		
		var objStatic = new Static("st_label", 42, 0, nWidth-45, nHeight);
		objDiv.form.addChild("st_label", objStatic);
		objStatic.text(ds.getColumn(i, "name"));
		objStatic.addEventHandler("onclick", this.fn_filter_onclick, this);
		objStatic.show();
		
		var targetUuid = (type == "weapon") ? this.fv_selectedWeapon : this.fv_selectedTier;
		if(objDiv._uuid == targetUuid) {
			objDiv.cssclass("skins_weapon active");
			objStatic.cssclass("skins_weapon_active");
		}
		nLeft += nWidth + nGap;
	}
};

/** 4. 클릭 이벤트 **/
this.fn_filter_onclick = function(obj, e) {
	var targetDiv = null;
	var current = obj;
	
	if (obj.id.indexOf("btn_") === -1 && (obj.id.indexOf("div_") === 0 || obj instanceof nexacro.Form)) {
		return false; 
	}
	
	while (current) {
		if (current.id && current.id.indexOf("btn_") === 0) {
			targetDiv = current;
			break;
		}
		current = current.parent;
		if (current && current instanceof nexacro.Form) current = current.parent;
		if (!current || current instanceof nexacro.ChildFrame) break;
	}
	
	if (!targetDiv || !targetDiv._uuid) return false;
	
	var pForm = targetDiv.parent; 
	for(var i=0; i<pForm.components.length; i++) {
		var comp = pForm.components[i];
		if(comp.id.indexOf("btn_") === 0) {
			comp.cssclass("skins_weapon");
			if(comp.form.st_label) comp.form.st_label.cssclass("skins_weapon");
		}
	}
	
	targetDiv.cssclass("skins_weapon active");
	if(targetDiv.form.st_label) {
		targetDiv.form.st_label.cssclass("skins_weapon_active");
	}
	
	if(targetDiv._type == "weapon") {
		this.fv_selectedWeapon = targetDiv._uuid;
	} else {
		this.fv_selectedTier = targetDiv._uuid;
	}
	
	this.fn_applyFilter();
	return false;
};

/** 5. 필터 적용 **/
this.fn_applyFilter = function() {
	var sFilter = "";
	if (this.fv_selectedWeapon != "all") sFilter = "weaponUuid=='" + this.fv_selectedWeapon + "'";
	if (this.fv_selectedTier != "all") {
		if (sFilter != "") sFilter += " && ";
		sFilter += "tierUuid=='" + this.fv_selectedTier + "'";
	}
	this.ds_skin.filter(sFilter);
	this.fn_makeSkinCards();
};

/** 6. 스킨 리스트 생성 (이미지 비율 수정) **/
this.fn_makeSkinCards = function() {
	var divObj = this.div_skin_list;
	var ds = this.ds_skin;
	var tForm = divObj.form;
	
	for(var i=tForm.components.length-1; i>=0; i--) {
		tForm.removeChild(tForm.components[i].id);
	}
	
	// 카드의 높이를 180 -> 140으로 조금 줄여서 총기가 더 가로로 길어 보이게 조정
	var nLeft = 15, nTop = 15, nWidth = 240, nHeight = 140, nGap = 15;
	
	for(var i=0; i<ds.rowcount; i++) {
		if (nLeft + nWidth > divObj.getOffsetWidth() - 30) { nLeft = 15; nTop += nHeight + nGap; }
		var cardId = "card_" + i;
		var objCard = new Div(cardId, nLeft, nTop, nWidth, nHeight);
		tForm.addChild(cardId, objCard);
		objCard.background("#2a2e35");
		objCard.borderRadius("6px");
		var tColor = ds.getColumn(i, "tierColor");
		objCard.border("0none, 0none, 4px solid #" + (tColor ? tColor.substring(0,6) : "444444"));
		objCard.show();
		
		// [수정] stretch를 "fixaspectratio"으로 설정하여 가로 비율을 유지하며 꽉 채움
		var objImg = new ImageViewer("img_skin", "5%", "10%", "90%", "60%");
		objCard.form.addChild("img_skin", objImg);
		objImg.image(ds.getColumn(i, "icon"));
		objImg.stretch("fixaspectratio"); 
		objImg.background("transparent");
		objImg.border("0none");
		objImg.show();
		
		var objStatic = new Static("st_name", 0, "75%", "100%", "20%");
		objCard.form.addChild("st_name", objStatic);
		objStatic.text(ds.getColumn(i, "name"));
		objStatic.color("#ffffff");
		objStatic.textAlign("center");
		objStatic.font("bold 10pt 'Malgun Gothic'");
		objStatic.show();
		
		nLeft += nWidth + nGap;
	}
	tForm.resetScroll();
};]]></Script>
    <Objects>
      <Dataset id="ds_weapon">
        <ColumnInfo>
          <Column id="UUID" type="STRING" size="256"/>
          <Column id="NAME" type="STRING" size="256"/>
          <Column id="ICON" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_tier">
        <ColumnInfo>
          <Column id="UUID" type="STRING" size="256"/>
          <Column id="NAME" type="STRING" size="256"/>
          <Column id="ICON" type="STRING" size="256"/>
          <Column id="COLOR" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_skin">
        <ColumnInfo>
          <Column id="WEAPON_UUID" type="STRING" size="256"/>
          <Column id="TIER_UUID" type="STRING" size="256"/>
          <Column id="NAME" type="STRING" size="256"/>
          <Column id="ICON" type="STRING" size="256"/>
          <Column id="TIER_ICON" type="STRING" size="256"/>
          <Column id="TIER_COLOR" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
  </Form>
</FDL>
